name: macOS App Bundle

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: ""

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Create .env file
      run: |
        cat > .env << EOF
        CLIENT_ID=${{ secrets.SOUNDCLOUD_CLIENT_ID }}
        CLIENT_SECRET=${{ secrets.SOUNDCLOUD_CLIENT_SECRET }}
        REDIRECT_URL=${{ secrets.SOUNDCLOUD_REDIRECT_URL }}
        EOF

    - name: Build release binary
      run: cargo build --release

    - name: Create app bundle structure
      run: |
        mkdir -p Rustwave.app/Contents/MacOS
        mkdir -p Rustwave.app/Contents/Resources

    - name: Copy executable
      run: cp target/release/rustwave Rustwave.app/Contents/MacOS/

    - name: Copy .env file
      run: cp .env Rustwave.app/Contents/MacOS/

    - name: Copy assets folder
      run: cp -r assets Rustwave.app/Contents/MacOS/

    - name: Create Info.plist
      run: |
        cat > Rustwave.app/Contents/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>rustwave</string>
            <key>CFBundleIdentifier</key>
            <string>com.rustwave.app</string>
            <key>CFBundleName</key>
            <string>Rustwave</string>
            <key>CFBundleDisplayName</key>
            <string>Rustwave</string>
            <key>CFBundleVersion</key>
            <string>0.1.0</string>
            <key>CFBundleShortVersionString</key>
            <string>0.1.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleSignature</key>
            <string>????</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.12</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSSupportsAutomaticGraphicsSwitching</key>
            <true/>
        </dict>
        </plist>
        EOF

    - name: Create icon set
      run: |
        mkdir -p AppIcon.iconset
        sips -z 16 16 assets/icon.png --out AppIcon.iconset/icon_16x16.png
        sips -z 32 32 assets/icon.png --out AppIcon.iconset/icon_16x16@2x.png
        sips -z 32 32 assets/icon.png --out AppIcon.iconset/icon_32x32.png
        sips -z 64 64 assets/icon.png --out AppIcon.iconset/icon_32x32@2x.png
        sips -z 128 128 assets/icon.png --out AppIcon.iconset/icon_128x128.png
        sips -z 256 256 assets/icon.png --out AppIcon.iconset/icon_128x128@2x.png
        sips -z 256 256 assets/icon.png --out AppIcon.iconset/icon_256x256.png
        sips -z 512 512 assets/icon.png --out AppIcon.iconset/icon_256x256@2x.png
        sips -z 512 512 assets/icon.png --out AppIcon.iconset/icon_512x512.png
        cp assets/icon.png AppIcon.iconset/icon_512x512@2x.png

    - name: Convert iconset to icns
      run: iconutil -c icns AppIcon.iconset

    - name: Copy icon to app bundle
      run: cp AppIcon.icns Rustwave.app/Contents/Resources/

    - name: Make executable
      run: chmod +x Rustwave.app/Contents/MacOS/rustwave

    - name: Create archive
      run: ditto -c -k --keepParent Rustwave.app Rustwave.app.zip

    - name: Upload app bundle
      uses: actions/upload-artifact@v4
      with:
        name: rustwave-macos-${{ github.sha }}
        path: Rustwave.app.zip
        retention-days: 30

    - name: Upload to release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Rustwave.app.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
